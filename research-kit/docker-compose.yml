services:
  rilot:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: rilot
    environment:
      RILOT_HOST: 0.0.0.0
      RILOT_PORT: 8080
      RUST_LOG: info
      RILOT_ENV: production
      RILOT_EXPOSE_RESEARCH_HEADERS: "true"
      RILOT_EMULATE_CROSS_REGION_RTT: "${RILOT_EMULATE_CROSS_REGION_RTT:-false}"
    volumes:
      - ./${CONFIG_FILE_NAME:-config.docker.json}:/app/config.json:ro
    ports:
      - "${RILOT_HOST_PORT:-8080}:8080"
    depends_on:
      - us-east
      - us-west

  us-east:
    image: node:20-alpine
    container_name: us-east
    working_dir: /sim
    volumes:
      - ../examples/node-apps:/sim:ro
    command: ["node", "/sim/us-east-app.js"]

  us-west:
    image: node:20-alpine
    container_name: us-west
    working_dir: /sim
    volumes:
      - ../examples/node-apps:/sim:ro
    command: ["node", "/sim/us-west-app.js"]

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: rilot-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - rilot
